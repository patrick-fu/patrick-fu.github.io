<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>杂谈网络协议之 TCP/IP | 派大星星星星</title>
  
  <meta name="keywords" content="iOS">
  
  

  

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  

  
  <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/fat_cat_header_small.png">
  

  
    <link rel="stylesheet" href="/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
    <!-- ba -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?420331e790ec3f2c56b1660b4958f8c3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <img class='logo' src='https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/fat_cat_header_small.png'/>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-beer fa-fw'></i>&nbsp;博客
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/categories/"
            
            
            id="categories">
            <i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/tags/"
            
            
            id="tags">
            <i class='fas fa-tags fa-fw'></i>&nbsp;标签
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/archives/"
            
            
            id="archives">
            <i class='fas fa-archive fa-fw'></i>&nbsp;归档
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          派大星星星星
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-beer fa-fw'></i>&nbsp;博客
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                  
                  id="tags">
									<i class='fas fa-tags fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/archives/"
                  
                  
                  id="archives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-beer fa-fw'></i>&nbsp;博客
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/categories/"
                
                
                id="categories">
								<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/tags/"
                
                
                id="tags">
								<i class='fas fa-tags fa-fw'></i>&nbsp;标签
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/archives/"
                
                
                id="archives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;归档
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  
    <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2019-06-06-network-protocol-ip-tcp-udp/">
        杂谈网络协议之 TCP/IP
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://paaatrick.com" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>大星</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2019-06-06</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/Tech/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Tech</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          <p>最近学了些TCP/IP相关的内容，做了些笔记。</p>
<a id="more"></a>

<p><a href="https://paaatrick.com/2019-06-03-network-protocol-https/">关于HTTP(S)、TLS的内容链接</a></p>
<h2 id="网络分层"><a href="#网络分层" class="headerlink" title="网络分层"></a>网络分层</h2><p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606103501.jpg" alt></p>
<h4 id="网络分层的原因"><a href="#网络分层的原因" class="headerlink" title="网络分层的原因"></a>网络分层的原因</h4><ul>
<li><p>复杂的程序都需要分层，各层次之间是独立的</p>
</li>
<li><p>某一层并不需要知道它的下一层是如何实现的，而仅仅需要知道该层通过层间的接口所提供的服务，这样能降低问题的复杂度，上层工作不影响下层的工作</p>
</li>
<li><p>易与多人协作，易与实现和维护，促进标准化工作</p>
</li>
<li><p>只要是在网络上跑的包，都是完整的，可以有下层没上层，绝不可能有上层没下层</p>
</li>
<li><p>对于TCP来说，只要想发出去包，就必须要有IP层和MAC层</p>
</li>
</ul>
<h4 id="网络如何分层"><a href="#网络如何分层" class="headerlink" title="网络如何分层"></a>网络如何分层</h4><ul>
<li>一般有五层模型和七层模型，按个人理解，七层模型只是把五层模型最上层的应用层给细化了<ol>
<li>物理层(中继器、集线器、HUB、网线)</li>
<li>数据链路层(MAC)</li>
<li>网络层(IP) </li>
<li>传输层(TCP/UDP) </li>
<li>应用层(HTTP(S))</li>
</ol>
</li>
</ul>
<h4 id="网络分层运行的过程"><a href="#网络分层运行的过程" class="headerlink" title="网络分层运行的过程"></a>网络分层运行的过程</h4><p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606104044.jpg" alt></p>
<ol>
<li>接收过程</li>
</ol>
<p>当一个包经过网口时，首先看看要不要请进来处理一下（配置了混杂模式的网口，凡是经过的都拿进来），拿进来以后交给一段程序处理，于是调用<code>process_layer2(buffer)</code>，当然这是假函数，但你知道肯定有类似功能的函数的，这个函数功能是从buffer中摘掉二层（MAC）的头查看。</p>
<p>假如发现这个包的MAC地址与自己相符，说明是发给你的，于是调用<code>process_layer3(buffer)</code>，摘掉三层（IP）的头查看，如果IP地址不是自己的，就应该转发出去，如果IP地址是自己的，就根据IP头的指示，拿掉三层的头，进程下一层的处理，如果地址是TCP的，调用<code>process_tcp(buffer)</code>，如果是UDP的调用<code>process_udp(buffer)</code>。</p>
<p>假设是TCP的，调用<code>process_tcp(buffer)</code>，查看四层的头，看是一个发起，还是应答，或者是一个正常的数据包，分别交给不同的逻辑处理。如果是发起或者应答，接下来可能要发送一个回复包；如果是一个正常的数据包，就需要交给上层了。交给谁呢？是不是有 <code>process_http(buffer)</code> 函数呢？</p>
<p>没有的，如果你是一个网络包处理程序，你不需要有process_http(buffer)，而是应该交给应用去处理。交给哪个应用呢？在四层的头里面有端口号，不同的应用监听不同的端口号。如果发现浏览器应用在监听这个端口，那你发给浏览器就行了。至于浏览器怎么处理，和你没有关系。</p>
<p>浏览器自然是解析 HTML，显示出页面来。电脑的主人看到页面很开心，就点了鼠标。点击鼠标的动作被浏览器捕获。浏览器知道，又要发起另一个 HTTP 请求了，于是使用端口号，将请求发给了你。</p>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606103753.jpg" alt></p>
<ol start="2">
<li>发送过程</li>
</ol>
<p>收到了一个封装好的HTTP包后，首先调用<code>send_tcp(buffer)</code>，<code>buffer</code>里就是HTTP请求的内容，这个函数里面加一个TCP的头，记录下浏览器给的源端口号，一般是80（HTTPS就443）。</p>
<p>然后调用<code>send_layer3(buffer)</code>，<code>buffer</code>里面已经有了HTTP的头和内容，以及TCP的头，这个函数里面加一个IP的头，记录下源IP地址和目标IP地址。</p>
<p>然后调用<code>send_layer2(buffer)</code>，<code>buffer</code>里面已经有了HTTP的头和内容、TCP的头，以及IP的头，这个函数里面加一个MAC的头，记录源MAC地址，得到的就是本机器的 MAC 地址和目标的 MAC 地址。不过，这个还要看当前知道不知道，知道就直接加上；不知道的话，就要通过一定的协议处理过程，找到 MAC 地址。反正要填一个，不能空着。</p>
<p>只要<code>buffer</code>里面的内容完整，就可以从网口发出去了。</p>
<h4 id="数据链路层-MAC"><a href="#数据链路层-MAC" class="headerlink" title="数据链路层 MAC"></a>数据链路层 MAC</h4><ul>
<li><p>MAC的全称是Medium Access Control，即媒体访问控制。</p>
</li>
<li><p>以太网规定，连入网络的所有设备，都必须具有”网卡”接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。</p>
</li>
<li><p>每块网卡出厂的时候，都有一个全世界独一无二的MAC地址，长度是48个二进制位，通常用12个十六进制数表示。</p>
<p> <img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606103751.jpg" alt></p>
</li>
<li><p>前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了。</p>
</li>
<li><p>一块网卡获取另一块网卡MAC地址的方式：ARP协议，当已知IP时请求MAC地址</p>
</li>
<li><p>ARP的工作方式：广播，向同个子网络内所有计算机发送数据包，让每台计算机自己判断自己是否为接收方</p>
<p> <img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606103754.jpg" alt></p>
</li>
</ul>
<h4 id="网络层-IP"><a href="#网络层-IP" class="headerlink" title="网络层 IP"></a>网络层 IP</h4><ul>
<li>ARP寻找MAC的广播方式只能在子网络内使用，每个子网络之间通信需要IP协议</li>
<li>Linux 上查看IP地址的命令：<code>ifconfig</code> 和 <code>ip addr</code>、没有的话自行安装<code>net-tools</code>和<code>iproute2</code></li>
</ul>
<ol>
<li><p>IP地址</p>
<ul>
<li>IPv4的网络地址由32个二进制位组成</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606103750.jpg" alt></p>
<ul>
<li>IP 地址是一个网卡在网络世界的通讯地址，相当于我们现实世界的门牌号码</li>
</ul>
</li>
<li><p>CIDR</p>
<ul>
<li>32位的IP地址分成了5类，但因为太浪费了，所以使用<code>CIDR</code></li>
<li>CIDR代替ABC类分配IP地址段，注意私有IP段，CIDR伴随广播地址和子网掩码</li>
</ul>
</li>
<li><p>IP的作用</p>
<ul>
<li>IP协议的作用主要有两个，一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。</li>
</ul>
</li>
<li><p>从IP得到MAC的方式</p>
<ul>
<li>因为IP数据包是放在以太网数据包里发送的，所以我们必须同时知道两个地址，一个是对方的MAC地址，另一个是对方的IP地址。通常情况下，对方的IP地址是已知的，但是我们不知道它的MAC地址。分两种情况</li>
</ul>
<ol>
<li>如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的”网关”（gateway），让网关去处理。</li>
<li>如果两台主机在同一个子网络，那么我们可以用ARP协议，得到对方的MAC地址。</li>
</ol>
</li>
</ol>
<ul>
<li>DHCP请求IP地址，DHCP附送PXE协议安装OS</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606130549.jpg" alt></p>
<h2 id="ICMP-和-ping"><a href="#ICMP-和-ping" class="headerlink" title="ICMP 和 ping"></a>ICMP 和 ping</h2><ul>
<li><p>ping 是基于 ICMP 工作的，ICMP全称Internet Control Message Protocol，就是互联网控制报文协议。</p>
</li>
<li><p>ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址。它本身非常简单。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606124731.jpg" alt></p>
<ol>
<li><p>查询报文</p>
<ul>
<li>ping 就是ICMP的查询报文，是一种主动请求，并获得主动应答的ICMP协议，不过ping在ICMP后面增加了自己的格式</li>
<li>ping 主动请求的发送：<code>ICMP ECHO REQUEST</code></li>
<li>ping 主动请求的回复：<code>ICMP ECHO REPLY</code></li>
<li>比原生ICMP多了两个字段：标识符、序号，以及可选存放请求的时间值，可计算往返时间</li>
</ul>
</li>
<li><p>差错报文</p>
<ul>
<li>终点不可达：3，分为网络不可达、主机不可达、协议不可达、端口不可达、需要进行分片但设置了不分片等</li>
<li>源抑制：4，让源站放慢发送速度</li>
<li>超时：11，超过网络包的生存时间还没到达目标</li>
<li>重定向：5，让下次发给另一个路由器</li>
</ul>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606124744.jpg" alt></p>
<ol start="3">
<li><p>ping 的发送和接收过程</p>
<ul>
<li>可以看出ping是使用了ICMP里的<code>ECHO REQUEST</code>和<code>ECHO REPLY</code></li>
</ul>
</li>
<li><p>TTL (TimeToLive)</p>
<ul>
<li>在IPv4中, TTL是IP协议的一个8个二进制位的值(0-255)，这个值可以被认为是数据包在internet系统中可以跳跃的次数上限。</li>
<li>TTL是由数据包的发送者设置的, 在前往目的地的过程中, 每经过一台主机或设备, 这个值就要减少一点。</li>
<li>如果在数据包到达目的地前, TTL值被减到了0，那么这个包将作为一个ICMP错误的数据包被丢弃。</li>
</ul>
</li>
<li><p>差错报文的应用<code>Traceroute</code> </p>
<ul>
<li>Traceroute 故意设置特殊的TTL，来追踪去往目的地时沿途经过的路由器</li>
<li>对目的IP地址发送UDP包，设置TTL为1，即到达第一个路由就挂掉了，然后返回一个ICMP差错报文包，类型是超时</li>
<li>然后设置TTL为2，继续到第二个路由就挂了，返回超时，逐步迭代这个过程取得整个路径上的路由IP和延迟</li>
<li>有些路由不会回复这个ICMP，这就是Traceroute返回内容部分空白的原因</li>
<li>另外一个作用是故意设置不分片，从而确定路径的MTU</li>
</ul>
</li>
</ol>
<h2 id="TCP-和-UDP-的区别"><a href="#TCP-和-UDP-的区别" class="headerlink" title="TCP 和 UDP 的区别"></a>TCP 和 UDP 的区别</h2><ol>
<li><p>TCP 面向连接，UDP 面向无连接</p>
</li>
<li><p>TCP 提供可靠交付，UDP 不可靠</p>
<ul>
<li>TCP 连接传输的数据，无差错，不丢失，不重复，按序到达</li>
<li>UDP 继承 IP 包的特性，不保证不丢失，不保证按顺序到达</li>
</ul>
</li>
<li><p>TCP 基于字节流，UDP 基于数据报</p>
<ul>
<li>TCP 发送的时候是一个流，没头没尾</li>
<li>虽然 IP 包是一个个的 IP 包，TCP 自己维护成了流</li>
<li>UDP 继承了 IP 的特性，基于数据报，一个个地发，一个个地收</li>
</ul>
</li>
<li><p>TCP 有拥塞控制， UDP 没有</p>
<ul>
<li>TCP 意识到包丢失或者网络环境差后，根据情况调整行为，调节发送速度</li>
<li>UDP 没有意识，应用叫发包就发</li>
</ul>
</li>
<li><p>TCP 是有状态服务，UDP 是无状态服务</p>
<ul>
<li>TCP 精确记录了发送、接收状态</li>
<li>UDP 不记录状态</li>
</ul>
</li>
</ol>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><h4 id="UDP-包头格式"><a href="#UDP-包头格式" class="headerlink" title="UDP 包头格式"></a>UDP 包头格式</h4><p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606130750.jpg" alt></p>
<ul>
<li>源端口号 | 目的端口号</li>
<li>16位UDP长度 | 16位UDP校验和</li>
<li>数据</li>
</ul>
<h4 id="UDP-特点"><a href="#UDP-特点" class="headerlink" title="UDP 特点"></a>UDP 特点</h4><ol>
<li><p>沟通简单，认为网络通路默认就是很容易送达的，不容易被丢弃的</p>
</li>
<li><p>轻信他人， 不会建立连接，虽然有端口号，但是监听后任何人都能发数据给他，他也可以发数据给任何、任意多人</p>
</li>
<li><p>愣头青，不会根据网络情况进行发包的拥塞控制，无论丢包成什么样还是该怎么发就怎么发</p>
</li>
</ol>
<h4 id="UDP-使用场景"><a href="#UDP-使用场景" class="headerlink" title="UDP 使用场景"></a>UDP 使用场景</h4><ol>
<li><p>需要资源少，网络环境好的内网，或对丢包不敏感的应用。如 DCHP 和 TFTP 就是基于 UDP 协议的，因为BIOS资源少不适合维护TCP那种复杂的状态机</p>
</li>
<li><p>不需要一对一沟通建立连接，而是可以广播的应用。UDP 面向无连接的功能可以承载广播或者多播的协议，基于 UDP 的 DHCP 就是广播的形式</p>
</li>
<li><p>需要处理速度快，时延低，可容忍少数丢包，但即便网络拥塞也要不停歇发包的应用。比如网络直播，用户不关心过时数据，老数据丢了也就丢了，但不能因为拥塞而停歇了</p>
</li>
</ol>
<h4 id="UDP-使用例子"><a href="#UDP-使用例子" class="headerlink" title="UDP 使用例子"></a>UDP 使用例子</h4><ol>
<li><p>网页或者App的访问</p>
<ul>
<li>QUIC协议</li>
<li>移动互联，网络经常变换，TCP会经常重连很耗时，基于UDP的QUIC就比较合适</li>
</ul>
</li>
<li><p>流媒体协议</p>
<ul>
<li>TCP 的严格顺序传输不适合直播，用户不在意老数据而是要实时性，宁可丢包也不要卡顿</li>
<li>很多直播应用基于 UDP 实现自己的视频传输协议</li>
</ul>
</li>
<li><p>实时游戏</p>
<ul>
<li>游戏的实时性要求很高，而且服务器需要沟通很多客户端（玩家），在异步IO机制引入之前，UDP是应对海量客户端连接的策略</li>
<li>TCP的强顺序问题，对战游戏对网络要求简单，如FPS只需传输玩家位置和行为等，客户端解析响应并渲染场景，玩家并不关心过期数据，如果一个数据包丢失导致卡顿，下一秒就被爆头了。用UDP自定义可靠协议，自定义重传策略，能尽量降低延迟，减少网络问题对游戏性能的影响</li>
</ul>
</li>
<li><p>IoT 物联网</p>
<ul>
<li>物联网设备终端资源少，维护TCP开销太大</li>
<li>物联网对实时性要求高，TCP容易导致高延迟</li>
<li>Google子公司推出的物联网通信协议 Thread 就是基于 UDP 的</li>
</ul>
</li>
<li><p>移动通信领域</p>
<ul>
<li>4G 网络的数据协议 GTP-U 是基于 UDP 的</li>
</ul>
</li>
</ol>
<h4 id="UDP-小结"><a href="#UDP-小结" class="headerlink" title="UDP 小结"></a>UDP 小结</h4><ol>
<li><p>如果将 TCP 比作成熟的社会人，UDP 则是头脑简单的小朋友。TCP 复杂，UDP 简单；TCP 维护连接，UDP 谁都相信；TCP 会坚持知进退；UDP 愣头青一个，勇往直前；</p>
</li>
<li><p>UDP 虽然简单，但它有简单的用法。它可以用在环境简单、需要多播、应用层自己控制传输的地方。例如 DHCP、VXLAN、QUIC 等。</p>
</li>
</ol>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><ul>
<li>TCP的seq是32位的计数器，每4微秒加1，计算可知284分钟即4.73小时重置一次</li>
</ul>
<h4 id="TCP-包头格式"><a href="#TCP-包头格式" class="headerlink" title="TCP 包头格式"></a>TCP 包头格式</h4><p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606130901.jpg" alt></p>
<ul>
<li>源端口号 | 目标端口号</li>
<li>包序号:<code>seq</code></li>
<li>确认序号:<code>ack</code></li>
<li>首部长度 | 保留 | URG | ACK | PSH | RST | SYN | FIN | 16位窗口大小</li>
<li>校验和 | 紧急指针</li>
<li>选项</li>
<li>数据本体</li>
</ul>
<ol>
<li>首先与UDP一样是源端口和目标端口号，用于确定发给哪个应用</li>
<li><code>seq</code>序号解决乱序问题，确定每个包的先来后到，是个32位的计数器，每4微秒加1，计算可知284分钟即4.73小时重置一次</li>
<li><code>ack</code>的值是对方发来的TCP包内<code>seq</code>的值+1，解决不丢包问题</li>
<li>状态位，<code>SYN</code>是发起连接，<code>ACK</code>是回复，<code>RST</code>是重新连接，<code>FIN</code>是结束连接，这是TCP面向连接的体现，维护连接状态，这些带状态位的包的发送会引起双方的状态变更</li>
<li>窗口大小，做流量控制，双方各自声明一个窗口，标识自己当前的处理能力，不要发送得太快也别太慢</li>
</ol>
<h4 id="TCP-的特征"><a href="#TCP-的特征" class="headerlink" title="TCP 的特征"></a>TCP 的特征</h4><ul>
<li>顺序问题，稳重不乱；</li>
<li>丢包问题，承诺靠谱；</li>
<li>连接维护，有始有终；</li>
<li>流量控制，把握分寸；</li>
<li>拥塞控制，知进知退。</li>
</ul>
<h4 id="三次握手四次挥手"><a href="#三次握手四次挥手" class="headerlink" title="三次握手四次挥手"></a>三次握手四次挥手</h4><ol>
<li><p>三次握手</p>
<ul>
<li>① A：您好，我是 A ② B：您好 A，我是 B ③ A：您好 B</li>
<li>TCP连接的建立称为三次握手，“请求 -&gt; 应答 -&gt; 应答之应答”，让双方的消息都“有去有回”</li>
<li>第三次握手，A应答B的应答包，能解决一个问题：B收到了来自很久之前A的多次申请连接的SYN包，如果两次握手，B这时建立了连接就等于单相思，所以需要“应答之应答”</li>
<li>为什么不四次握手？因为就算40次握手也不能真正保证连接就建立了，只要双方都有去有回就基本认为建立了，并且一般A和B连接建立后就开始发数据，一但A方开始发送数据，问题就解决了</li>
<li>如果连接建立后A一直不发数据，这个在HTTP有keepalive机制，即使没有真实数据包也有探活包</li>
<li>B也可以设计对于长时间不发包的A主动关闭连接</li>
<li>大写<code>ACK</code>与小写<code>ack</code>的区别：大写的是状态位，当为1时表示包是回复包，小写是确认序号，值是对方的序号<code>seq</code>+1</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606132859.jpg" alt></p>
</li>
</ol>
<p>一开始，客户端和服务端都处于 <code>CLOSED</code> 状态。先是服务端主动监听某个端口，处于 <code>LISTEN</code> 状态。然后客户端主动发起连接 <code>SYN</code>，之后处于 <code>SYN-SENT</code> 状态。服务端收到发起的连接，返回 <code>SYN</code>，并且 <code>ACK</code> 客户端的 <code>SYN</code>，之后处于 <code>SYN-RCVD</code> 状态。客户端收到服务端发送的 <code>SYN</code> 和 <code>ACK</code> 之后，发送 <code>ACK</code> 的 <code>ACK</code>，之后处于 <code>ESTABLISHED</code> 状态，因为它一发一收成功了。服务端收到 <code>ACK</code> 的 <code>ACK</code> 之后，处于 <code>ESTABLISHED</code> 状态，因为它也一发一收了。</p>
<ol start="2">
<li><p>四次挥手</p>
<ul>
<li>由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这个原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。</li>
</ul>
<ol>
<li>客户端A发送一个FIN，用来关闭客户A到服务器B的数据传送</li>
<li>服务器B收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号</li>
<li>服务器B关闭与客户端A的连接，发送一个FIN给客户端A</li>
<li>客户端A发回ACK报文确认，并将确认序号设置为收到序号加1</li>
</ol>
<ul>
<li>上面2与3的过程中，B可能还有要发给A的数据没发送完，就首先ACK了A的FIN后，等处理完数据后再发送FIN给A，所以一共需要4次挥手。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606132901.jpg" alt></p>
</li>
<li><p>白话解释四次挥手</p>
<ul>
<li><p>① A：B 啊，我不想玩了 ② B：哦，你不想玩了啊，我知道了 ③ B：A 啊，好吧，我也不玩了，拜拜 ④ A：好的，拜拜。</p>
</li>
<li><p>A 开始说“不玩了”，B 说“知道了”，这个回合是没什么问题的，因为在此之前，双方还处于合作的状态，如果 A 说“不玩了”，没有收到回复，则 A 会重新发送“不玩了”。但是这个回合结束之后，就有可能出现异常情况了，因为已经有一方率先撕破脸。</p>
</li>
<li><p>一种情况是，A 说完“不玩了”之后，直接跑路，是会有问题的，因为 B 还没有发起结束，而如果 A 跑路，B 就算发起结束，也得不到回答，B 就不知道该怎么办了。另一种情况是，A 说完“不玩了”，B 直接跑路，也是有问题的，因为 A 不知道 B 是还有事情要处理，还是过一会儿会发送结束。</p>
</li>
<li><p>断开的时候，我们可以看到，当 A 说“不玩了”，就进入 FIN_WAIT_1 的状态，B 收到“A 不玩”的消息后，发送知道了，就进入 CLOSE_WAIT 的状态。</p>
</li>
<li><p>A 收到“B 说知道了”，就进入 FIN_WAIT_2 的状态，如果这个时候 B 直接跑路，则 A 将永远在这个状态。TCP 协议里面并没有对这个状态的处理，但是 Linux 有，可以调整 tcp_fin_timeout 这个参数，设置一个超时时间。</p>
</li>
<li><p>如果 B 没有跑路，发送了“B 也不玩了”的请求到达 A 时，A 发送“知道 B 也不玩了”的 ACK 后，从 FIN_WAIT_2 状态结束，按说 A 可以跑路了，但是最后的这个 ACK 万一 B 收不到呢？则 B 会重新发一个“B 不玩了”，这个时候 A 已经跑路了的话，B 就再也收不到 ACK 了，因而TCP 协议要求 A 最后等待一段时间 TIME_WAIT，这个时间要足够长，长到如果 B 没收到 ACK 的话，“B 说不玩了”会重发的，A 会重新发一个 ACK 并且足够时间到达 B。</p>
</li>
<li><p>A 直接跑路还有一个问题是，A 的端口就直接空出来了，但是 B 不知道，B 原来发过的很多包很可能还在路上，如果 A 的端口被一个新的应用占用了，这个新的应用会收到上个连接中 B 发过来的包，虽然序列号是重新生成的，但是这里要上一个双保险，防止产生混乱，因而也需要等足够长的时间，等到原来 B 发送的所有的包都死翘翘，再空出端口来。</p>
</li>
<li><p>等待的时间设为 2MSL，MSL是Maximum Segment Lifetime，报文最大生存时间，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。因为 TCP 报文基于是 IP 协议的，而 IP 头中有一个TTL 域，是 IP 数据报可以经过的最大路由数，每经过一一个处理他的路由器此值就减 1，当此值为 0 则数据报将被丢弃，同时发送 ICMP 报文通知源主机。协议规定 MSL 为2 分钟，实际应用中常用的是 30 秒，1 分钟和 2 分钟等。</p>
</li>
<li><p>还有一个异常情况就是，B 超过了 2MSL 的时间，依然没有收到它发的 FIN 的 ACK，怎么办呢？按照 TCP 的原理，B 当然还会重发 FIN，这个时候 A 再收到这个包之后，A 就表示，我已经在这里等了这么长时间了，已经仁至义尽了，之后的我就都不认了，于是就直接发送 RST，B 就知道 A 早就跑了。</p>
</li>
</ul>
</li>
<li><p>TCP 状态机</p>
</li>
</ol>
<ul>
<li>把上面两个时序图合并起来就是这个TCP状态机图</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606132904.jpg" alt></p>
<ul>
<li>加黑加粗的部分是主要流程，阿拉伯数字的序号是连接建立的顺序，大写中文数字的序号是连接断开的顺序。加粗实线是客户端A的状态变化过程，加粗虚线是服务端B的状态变化过程。细虚线是其他非主流过程。</li>
</ul>
<h4 id="TCP-的顺序机制"><a href="#TCP-的顺序机制" class="headerlink" title="TCP 的顺序机制"></a>TCP 的顺序机制</h4><ul>
<li><p>每个包都有一个ID，按照ID一个个发送</p>
</li>
<li><p>累计确认（累计应答）</p>
<ul>
<li>发送端和接收端分别有缓存保存记录所有发送和接收的包</li>
</ul>
</li>
</ul>
<ol>
<li><p>发送端窗口</p>
<ul>
<li><p>发送端的缓存里是按照包ID排列的，有四种类型</p>
<ol>
<li>发送了且已确认</li>
<li>发送了且尚未确认</li>
<li>还没发送但等待发送</li>
<li>还没发送且暂时不会发送</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606145507.jpg" alt></p>
</li>
<li><p>上面3和4的区分是流量控制</p>
<ol>
<li>流量控制使用窗口（<code>Advertised Window</code>），窗口大小等于上面2+3部分，即发送未确认和未发送但可发送的</li>
<li><code>LastByteAcked</code>：第一部分和第二部分的分界线</li>
<li><code>LastByteSent</code>：第二部分和第三部分的分界线</li>
<li><code>LastByteAcked + AdvertisedWindow</code>：第三部分和第四部分的分界线</li>
</ol>
</li>
</ul>
</li>
<li><p>接收端窗口</p>
<ul>
<li>接收端的缓存里是按照包ID排列的，有三种类型<ol>
<li>接收且确认过</li>
<li>尚未接收但可接收</li>
<li>尚未接收且不能接收</li>
</ol>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606145846.jpg" alt></p>
<ul>
<li><p>流量控制使用窗口（<code>AdvertisedWindow</code>），窗口大小是上面第2部分，需要计算</p>
<ol>
<li><code>MaxRcvBuffer</code>：最大缓存的量；</li>
<li><code>LastByteRead</code> 之后是已经接收了，但是还没被应用层读取的；</li>
<li><code>NextByteExpected</code> 是第一部分和第二部分的分界线。</li>
</ol>
<ul>
<li><code>NextByteExpected</code> 和 <code>LastByteRead</code> 的差其实是还没被应用层读取的部分占用掉的 <code>MaxRcvBuffer</code> 的量，我们定义为 <code>A</code>。</li>
<li><code>AdvertisedWindow</code> 其实是 <code>MaxRcvBuffer</code> 减去 <code>A</code>，即第2部分的大小</li>
<li>也就是：<code>AdvertisedWindow = MaxRcvBuffer - ((NextByteExpected-1) - LastByteRead)</code>。</li>
<li>第2部分和第3部分的分界线就是 <code>NextByteExpected</code> + <code>AdvertisedWindow</code>，即 <code>LastByteRead</code> + <code>MaxRcvBuffer</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="TCP-的丢包重发机制"><a href="#TCP-的丢包重发机制" class="headerlink" title="TCP 的丢包重发机制"></a>TCP 的丢包重发机制</h4><ol>
<li><p>确认与重发机制</p>
<ul>
<li>超时重试，没有<code>ACK</code>的包都有设一个定时器，超过一定时间就重新尝试</li>
<li>超时时间需要大于往返时间 RTT，也不宜过长</li>
</ul>
</li>
<li><p>自适应重传算法</p>
<ul>
<li>TCP 通过采样 RTT 时间和 RTT 的波动范围，进行加权平均，算出一个值，还需要根据新状况不断变化</li>
<li>超时触发重传的问题是超时周期可能很长</li>
</ul>
</li>
<li><p>快速重传机制</p>
<ul>
<li>当接收方收到一个序号大于下一个所期望的报文段时，就检测到了数据流中的一个间格，于是发送三个冗余的 ACK，客户端收到后，就在定时器过期之前，重传丢失的报文段。</li>
<li>还有一种方式 <code>SACK</code> (Selective Acknowledgment)，在TCP头里加一个SACK，可以把可以将缓存的地图发送给发送方。</li>
</ul>
</li>
</ol>
<h4 id="TCP-的流量控制机制"><a href="#TCP-的流量控制机制" class="headerlink" title="TCP 的流量控制机制"></a>TCP 的流量控制机制</h4><ul>
<li><p>如果发送方发送太猛，接收方处理不过来导致缓存中没有空间，可以通过确认信息修改窗口大小，甚至设为0，使发送方暂时停止发送</p>
</li>
<li><p>当发送方发现自己窗口被调整到0后，会定时发送窗口探测数据包，看是否有机会调整窗口大小</p>
</li>
<li><p>当接收方比较慢时，要防止低能窗口综合征，避免空出一个字节就通知发送方然后又填满窗口。当窗口太小时，可以暂停更新窗口，直到窗口达到一定大小或者缓冲区一半为空，才更新窗口</p>
</li>
</ul>
<h4 id="TCP-的拥塞控制机制"><a href="#TCP-的拥塞控制机制" class="headerlink" title="TCP 的拥塞控制机制"></a>TCP 的拥塞控制机制</h4><ol>
<li><p>也是通过窗口大小控制，滑动窗口 <code>rwnd</code> 是怕发送方把接收方缓存占满，拥塞窗口 <code>cwnd</code> 是怕把网络塞满</p>
<ul>
<li><p><code>LastByteSent - LastByteAcked &lt;= min {cwnd, rwnd}</code>，是拥塞窗口和滑动窗口共同控制发送的速度</p>
</li>
<li><p>发送方难以判断网络是否满的方法，在TCP看来网络路径是一个黑盒</p>
</li>
<li><p>TCP 发送包常被比喻为往一个水管里面灌水，而 TCP 的拥塞控制就是在不堵塞，不丢包的情况下，尽量发挥带宽。</p>
</li>
</ul>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606152532.jpg" alt></p>
<ol start="2">
<li><p>TCP 的拥塞控制主要用来避免两种现象：包丢失和超时重传</p>
<ul>
<li><p>一旦出现了这些现象就说明，发送速度太快了，要慢一点。但是一开始我怎么知道速度多快呢，我怎么知道应该把窗口调整到多大呢？</p>
</li>
<li><p>慢启动：一开始 <code>cwnd</code> 大小为一个报文段，当收到确认时指数型增大<code>cwnd</code>大小</p>
</li>
<li><p>指数型涨到一个值为65535字节的 <code>ssthresh</code> 时降为线性增长，每8个确认<code>cwnd</code>增加1，但总有溢出的时候。</p>
</li>
<li><p>当出现拥塞即丢包时，需要超时重传，<code>ssthresh</code>设为<code>cwnd/2</code>，<code>cwnd</code>设为1，重新开始慢启动，一夜回到解放前。</p>
</li>
</ul>
</li>
<li><p>快速重传</p>
<ul>
<li><p>当接收端发现丢了一个中间包时，发送三次前一个包的ACK，于是发送端就会快速重传，不必等待超时重传。</p>
</li>
<li><p>此时<code>cwnd</code> = <code>cwnd</code> / 2， <code>sshthresh</code> = <code>cwnd</code>，当三个包返回时，<code>cwnd = sshthresh + 3</code></p>
</li>
<li><p>也就是不用回到解放前，只是减半而已</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606153531.jpg" alt></p>
<ul>
<li><p>这种机制导致延迟高的情况下，反而降低速度，导致本文前面UDP部分里说的TCP的问题</p>
<ol>
<li><p>丢包不代表通道满了，可能本身公网就是会丢包的，这时其实并没有拥塞</p>
</li>
<li><p>TCP 的拥塞控制要等到将中间设备都填充满了才发生丢包，从而降低发送速度，此时已经晚了，其实TCP只要通道满了就应该开始控制了，而不应该等到连缓存都满了才控制</p>
</li>
</ol>
</li>
<li><p>解决方法：<code>BBR</code> 拥塞算法，找到一个平衡点，填满管道但是不填满中间设备的缓存，达到高带宽和低时延的平衡</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190606153950.jpg" alt></p>
</li>
</ol>
<h4 id="TCP-小结"><a href="#TCP-小结" class="headerlink" title="TCP 小结"></a>TCP 小结</h4><ul>
<li>TCP 包头很复杂，但是主要关注五个问题，顺序问题，丢包问题，连接维护，流量控制，拥塞控制</li>
<li>连接的建立是经过三次握手，断开的时候四次挥手</li>
<li>顺序问题、丢包问题、流量控制都是通过滑动窗口来解决的</li>
<li>拥塞控制是通过拥塞窗口来解决的</li>
</ul>

        </div>
        
          


  <section class='meta' id="footer-meta">
    <hr>
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-08-01T18:15:29+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>最后更新于 2019年8月1日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/NetworkProtocol/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>NetworkProtocol</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://paaatrick.com/2019-06-06-network-protocol-ip-tcp-udp/&title=杂谈网络协议之 TCP/IP | 派大星星星星&summary=最近学了些TCP/IP相关的内容，做了些笔记。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://paaatrick.com/2019-06-06-network-protocol-ip-tcp-udp/&title=杂谈网络协议之 TCP/IP | 派大星星星星&summary=最近学了些TCP/IP相关的内容，做了些笔记。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACsklEQVR42u3aQW7jMBAEwPz/01lgr7tWumdIx4fSyUBkicUA5Lg5X1/x9f33evX51fX8tH/vTL71dePCw8PDGw39eYjJX5Oh53cem1Y8PDy8a7xkM0iW8uRpryb3+ZnJFoKHh4f3abxkcMkr22K6HQ8eHh7eZ/L2pfCpQAQPDw/vt3ibuKEtspMQYTYGPDw8vPfw9gdg7//81vM9PDw8vHhLOHVAlR//51tFNFo8PDy8C7xZC9S+LeCZPSuOi18MeHh4eAteuxBvDqvy4T7fn08QHh4e3g1eXuy2L25br07FE3XTKh4eHl7JO9V+mhTT7bFWvs28vB8PDw/vLbx2P8kP7/NpmjUfFPsYHh4e3oI3I81ek0e6m+OxIozAw8PDG/H2jaftQt82oc7iDDw8PLz38HLSrMmg3WDa8vo/f8XDw8O7wMtjgs2v+01p3lJf/g/x8PDwDvFm0WqyiM9ykX1YjIeHh3ebN1u4NwdXURE8Cjte4vHw8PAu8PZxahvvni3No2nFw8PDO8TLA9wc3BbZ38E1bEfAw8PDu8CbLdObNqn9FrKKKvDw8PAO8Z4jhtmy3j6hjSHyrQIPDw/vLG+2h+TtVrMiOBlVxMbDw8O7xpu1ArTfypf4YYvAc9MAHh4e3iFeW33nrQNtK9XmIG0WeeDh4eHNePsDp2QQOWAWi+Dh4eH9Li9f9E9tBi2yCEfw8PDwLvDapb/4qT9a6Nsw4kAAgYeHh1fyzoazbdHc3pOP54dfDHh4eHgL3n6Jb8HJkVVesq9Sajw8PLwFb78ZtK/fFOJ1SwEeHh7eNd6pOLWNffPntBsYHh4e3ifw8mU9KbJbcILBw8PD+2Re3n46ixvaSfwhjMDDw8O7wJuFEQcS4jImzicaDw8P7x5v9vq2RSAvl2eT+7W58PDw8FLeHyHnh1xylUerAAAAAElFTkSuQmCC'>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/wechat.png">
        
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://paaatrick.com/2019-06-06-network-protocol-ip-tcp-udp/&title=杂谈网络协议之 TCP/IP | 派大星星星星&summary=最近学了些TCP/IP相关的内容，做了些笔记。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACsklEQVR42u3aQW7jMBAEwPz/01lgr7tWumdIx4fSyUBkicUA5Lg5X1/x9f33evX51fX8tH/vTL71dePCw8PDGw39eYjJX5Oh53cem1Y8PDy8a7xkM0iW8uRpryb3+ZnJFoKHh4f3abxkcMkr22K6HQ8eHh7eZ/L2pfCpQAQPDw/vt3ibuKEtspMQYTYGPDw8vPfw9gdg7//81vM9PDw8vHhLOHVAlR//51tFNFo8PDy8C7xZC9S+LeCZPSuOi18MeHh4eAteuxBvDqvy4T7fn08QHh4e3g1eXuy2L25br07FE3XTKh4eHl7JO9V+mhTT7bFWvs28vB8PDw/vLbx2P8kP7/NpmjUfFPsYHh4e3oI3I81ek0e6m+OxIozAw8PDG/H2jaftQt82oc7iDDw8PLz38HLSrMmg3WDa8vo/f8XDw8O7wMtjgs2v+01p3lJf/g/x8PDwDvFm0WqyiM9ykX1YjIeHh3ebN1u4NwdXURE8Cjte4vHw8PAu8PZxahvvni3No2nFw8PDO8TLA9wc3BbZ38E1bEfAw8PDu8CbLdObNqn9FrKKKvDw8PAO8Z4jhtmy3j6hjSHyrQIPDw/vLG+2h+TtVrMiOBlVxMbDw8O7xpu1ArTfypf4YYvAc9MAHh4e3iFeW33nrQNtK9XmIG0WeeDh4eHNePsDp2QQOWAWi+Dh4eH9Li9f9E9tBi2yCEfw8PDwLvDapb/4qT9a6Nsw4kAAgYeHh1fyzoazbdHc3pOP54dfDHh4eHgL3n6Jb8HJkVVesq9Sajw8PLwFb78ZtK/fFOJ1SwEeHh7eNd6pOLWNffPntBsYHh4e3ifw8mU9KbJbcILBw8PD+2Re3n46ixvaSfwhjMDDw8O7wJuFEQcS4jImzicaDw8P7x5v9vq2RSAvl2eT+7W58PDw8FLeHyHnh1xylUerAAAAAElFTkSuQmCC'>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qrcode.png">
        
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                            <h4>
                                <a href="/2019-07-07-network-protocol-p2p/" rel="prev" title="杂谈网络协议之种子与P2P">
                                  
                                      杂谈网络协议之种子与P2P
                                  
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/tags/NetworkProtocol/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>NetworkProtocol</a>
                                </h6>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/2019-06-03-network-protocol-https/" rel="prev" title="杂谈网络协议之 HTTP、HTTPS 和 TLS">
                                    
                                        杂谈网络协议之 HTTP、HTTPS 和 TLS
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/tags/NetworkProtocol/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>NetworkProtocol</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments">
    <section class="article typo">
      <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;评论</h4>
      
        <section id="comments">
          <div id="disqus_thread">
            <div><i class='fas fa-exclamation-triangle'>&nbsp;无法加载Disqus评论系统，请确保您的网络能够正常访问。</div>
          </div>
        </section>
      
      
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '杂谈网络协议之 TCP/IP',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
        
          
          
            <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516125601.jpg'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="https://github.com/Fongim"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:me@paaatrick.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://me.csdn.net/fongim"
              class="social fab fa-contao flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div>
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#网络分层"><span class="toc-text">网络分层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#网络分层的原因"><span class="toc-text">网络分层的原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#网络如何分层"><span class="toc-text">网络如何分层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#网络分层运行的过程"><span class="toc-text">网络分层运行的过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据链路层-MAC"><span class="toc-text">数据链路层 MAC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#网络层-IP"><span class="toc-text">网络层 IP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMP-和-ping"><span class="toc-text">ICMP 和 ping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-和-UDP-的区别"><span class="toc-text">TCP 和 UDP 的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP"><span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-包头格式"><span class="toc-text">UDP 包头格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-特点"><span class="toc-text">UDP 特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-使用场景"><span class="toc-text">UDP 使用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-使用例子"><span class="toc-text">UDP 使用例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-小结"><span class="toc-text">UDP 小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP"><span class="toc-text">TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-包头格式"><span class="toc-text">TCP 包头格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-的特征"><span class="toc-text">TCP 的特征</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三次握手四次挥手"><span class="toc-text">三次握手四次挥手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-的顺序机制"><span class="toc-text">TCP 的顺序机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-的丢包重发机制"><span class="toc-text">TCP 的丢包重发机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-的流量控制机制"><span class="toc-text">TCP 的流量控制机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-的拥塞控制机制"><span class="toc-text">TCP 的拥塞控制机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-小结"><span class="toc-text">TCP 小结</span></a></li></ol></li></ol></li></ol>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/categories/"
    title="categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/Algorithm/" href="/categories/Algorithm/"><div class='name'>Algorithm</div><div class='badge'>(10)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Life/" href="/categories/Life/"><div class='name'>Life</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Note/" href="/categories/Note/"><div class='name'>Note</div><div class='badge'>(14)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Tech/" href="/categories/Tech/"><div class='name'>Tech</div><div class='badge'>(15)</div></a></li>
        
      </ul>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget tagcloud'>
    
<header class='pure'>
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/tags/"
    title="tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <a href="/tags/Algorithm/" style="font-size: 20px; color: #707070">Algorithm</a> <a href="/tags/Android/" style="font-size: 14px; color: #999">Android</a> <a href="/tags/Audio-Video/" style="font-size: 14px; color: #999">Audio/Video</a> <a href="/tags/CMake/" style="font-size: 14px; color: #999">CMake</a> <a href="/tags/CocoaPods/" style="font-size: 14px; color: #999">CocoaPods</a> <a href="/tags/Flutter/" style="font-size: 14px; color: #999">Flutter</a> <a href="/tags/Food/" style="font-size: 16px; color: #8b8b8b">Food</a> <a href="/tags/GN/" style="font-size: 14px; color: #999">GN</a> <a href="/tags/Hotel/" style="font-size: 14px; color: #999">Hotel</a> <a href="/tags/LeetCode/" style="font-size: 20px; color: #707070">LeetCode</a> <a href="/tags/NetworkProtocol/" style="font-size: 18px; color: #7e7e7e">NetworkProtocol</a> <a href="/tags/Ninja/" style="font-size: 14px; color: #999">Ninja</a> <a href="/tags/Objective-C/" style="font-size: 22px; color: #636363">Objective-C</a> <a href="/tags/Python/" style="font-size: 20px; color: #707070">Python</a> <a href="/tags/QuickLook/" style="font-size: 14px; color: #999">QuickLook</a> <a href="/tags/Swift/" style="font-size: 14px; color: #999">Swift</a> <a href="/tags/SwiftUI/" style="font-size: 14px; color: #999">SwiftUI</a> <a href="/tags/Windows/" style="font-size: 14px; color: #999">Windows</a> <a href="/tags/WordPress/" style="font-size: 16px; color: #8b8b8b">WordPress</a> <a href="/tags/iOS/" style="font-size: 24px; color: #555">iOS</a> <a href="/tags/macOS/" style="font-size: 14px; color: #999">macOS</a>
    </div>
  </section>


          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="https://github.com/Fongim"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:me@paaatrick.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://me.csdn.net/fongim"
            class="social fab fa-contao flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>©2019 派大星星星星</p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        const images = ["https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120523.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120522.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120521.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120520.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120519.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120518.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120517.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120516.jpeg", "https://raw.githubusercontent.com/Fongim/personal_blog_image/master/image/20190516120515.jpeg"];
        for (let i = 1; i < images.length; i++) {
          const random = Math.floor(Math.random() * (i + 1));
          [images[i], images[random]] = [images[random], images[i]];
        }
        if ('') {
          $('').backstretch(images, 
          {
            duration: "40000",
            fade: "2500"
          });
        } else {
          $.backstretch(images, 
          {
            duration: "40000",
            fade: "2500"
          });
        }
      });
    </script>
  





  <script>
    var disqus_shortname = 'paaatrick-com';
    
      var disqus_url = 'https://paaatrick.com/2019-06-06-network-protocol-ip-tcp-udp/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>







  <script src="/js/app.js"></script>


  <script src="/js/search.js"></script>




<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
